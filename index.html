<script>
    // Global data storage
    let leagueData = {
        teams: {
            first: [],
            second: [],
            female: [],
            'third-jj': [],
            'third-ej': []
        },
        fixtures: [],
        results: [],
        logos: {
            courtside: null,
            teams: {},
            cover: null
        },
        initialized: false
    };

    // Admin access
    let adminClickCount = 0;
    let clickTimeout = null;

    // Enhanced notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#0066cc'};
            color: white; padding: 1rem 2rem; border-radius: 15px; z-index: 10001; box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); animation: slideInRight 0.3s ease; max-width: 350px; border: 2px solid rgba(255,255,255,0.2);
        `;
        notification.innerHTML = `<div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i><span>${message}</span></div>`;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Admin access
    function adminAccess() {
        adminClickCount++;
        if (clickTimeout) clearTimeout(clickTimeout);

        const counter = document.getElementById('click-counter');
        if (counter) counter.textContent = `Clicks: ${adminClickCount}/5`;

        document.getElementById('admin-access').style.display = 'block';

        if (adminClickCount >= 5) {
            document.body.classList.add('admin-mode');
            document.getElementById('admin-access').innerHTML = `
                <h3><i class="fas fa-unlock" style="color: var(--success-green);"></i> Admin Access Granted!</h3>
                <p>Welcome to the admin panel</p>
            `;
            setTimeout(() => document.getElementById('admin-access').style.display = 'none', 2000);
            adminClickCount = 0;
            return;
        }

        clickTimeout = setTimeout(() => {
            adminClickCount = 0;
            document.getElementById('admin-access').style.display = 'none';
        }, 3000);
    }

    // Cover photo
    function uploadCoverPhotoAdmin(event) {
        const file = event.target.files[0];
        if (file && file.size < 5 * 1024 * 1024) {
            const reader = new FileReader();
            reader.onload = function(e) {
                leagueData.logos.cover = e.target.result;
                displayCoverPhoto(e.target.result);
                showNotification('Cover photo updated!', 'success');
            };
            reader.readAsDataURL(file);
        } else {
            showNotification('File too large. Max 5MB.', 'error');
        }
    }

    function displayCoverPhoto(src) {
        const coverDisplay = document.getElementById('cover-display');
        const coverImage = document.getElementById('cover-image');
        coverImage.src = src;
        coverDisplay.style.display = 'block';
    }

    // Logo upload
    function uploadCourtsideLogo(event) {
        const file = event.target.files[0];
        if (file && file.size < 2 * 1024 * 1024) {
            const reader = new FileReader();
            reader.onload = function(e) {
                leagueData.logos.courtside = e.target.result;
                document.getElementById('main-logo').innerHTML = `<img src="${e.target.result}" alt="Courtside Liberia">`;
                showNotification('Logo updated!', 'success');
            };
            reader.readAsDataURL(file);
        } else {
            showNotification('Logo too large. Max 2MB.', 'error');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showSection(this.dataset.section);
            });
        });
        showSection('home');
        initializeSampleData();
    });

    // Navigation
    function showSection(sectionName) {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
            section.style.transition = 'opacity 0.3s ease';
            section.style.opacity = '0';
        });
        setTimeout(() => {
            sections.forEach(section => section.classList.add('hidden'));
            if (sectionName === 'home') {
                document.getElementById('home').classList.remove('hidden');
                document.getElementById('divisions').classList.remove('hidden');
            } else {
                document.getElementById(sectionName).classList.remove('hidden');
            }
            sections.forEach(section => {
                if (!section.classList.contains('hidden')) {
                    section.style.opacity = '1';
                }
            });
        }, 150);

        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => link.classList.remove('active'));
        document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
    }

    // Admin
    function toggleAdmin() {
        const panel = document.getElementById('admin-panel');
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            showNotification('Admin panel opened', 'info');
        } else {
            panel.classList.add('hidden');
        }
    }

    function showAdminTab(tabName) {
        const contents = document.querySelectorAll('.admin-content');
        contents.forEach(content => content.classList.add('hidden'));
        document.getElementById(`admin-${tabName}`).classList.remove('hidden');
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        if (tabName === 'fixtures') {
            updateFixtureTeams();
            renderAdminFixtures();
        } else if (tabName === 'matches') {
            updateMatchTeams();
        }
    }

    // Initialize sample data
    function initializeSampleData() {
        if (leagueData.initialized) return;

        leagueData.teams.first = [
            'Mighty Barrolle FC', 'LPRC Oilers', 'Monrovia Club Breweries', 
            'University of Liberia Panthers', 'Nimba United', 'Grand Bassa Warriors'
        ];
        leagueData.teams.second = [
            'Rising Stars FC', 'New Generation Eagles', 'Future Lions', 
            'Coastal United', 'Jungle Lions', 'River Gee Tigers'
        ];
        leagueData.teams.female = [
            'Lady Breweries', 'Queens United', 'Female Warriors', 
            'Lady Eagles', 'Liberian Diamonds', 'Monrovia Queens'
        ];
        leagueData.teams['third-jj'] = [
            'JJ Roberts Lions', 'Roberts United', 'Young Talents FC', 
            'Future Stars', 'Paynesville Bulls', 'New Kru Town Eagles'
        ];
        leagueData.teams['third-ej'] = [
            'EJ Roye Warriors', 'Roye Eagles', 'New Hope FC', 
            'Rising Sun United', 'Caldwell Spartans', 'Logan Town Knights'
        ];

        leagueData.fixtures.push({
            id: Date.now() + 1,
            division: 'first',
            homeTeam: 'Mighty Barrolle FC',
            awayTeam: 'LPRC Oilers',
            date: '2025-04-10',
            time: '15:00',
            played: false
        });

        leagueData.results.push({
            id: Date.now() + 3,
            division: 'first',
            homeTeam: 'University of Liberia Panthers',
            awayTeam: 'Monrovia Club Breweries',
            date: '2025-04-05',
            homeScore: 78,
            awayScore: 72,
            forfeit: false,
            played: true
        });

        leagueData.initialized = true;
        renderAllTeams();
        updateFixtureTeams();
        renderFixtures();
        renderResults();
    }

    // Teams
    function addTeam() {
        const division = document.getElementById('team-division').value;
        const name = document.getElementById('team-name').value.trim();
        const logoFile = document.getElementById('team-logo').files[0];

        if (!name) return showNotification('Enter team name', 'error');
        if (leagueData.teams[division].includes(name)) return showNotification('Team exists', 'error');

        leagueData.teams[division].push(name);

        if (logoFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const logoKey = `${division}-${name}`;
                leagueData.logos.teams[logoKey] = e.target.result;
                renderAllTeams();
            };
            reader.readAsDataURL(logoFile);
        }

        document.getElementById('team-name').value = '';
        document.getElementById('team-logo').value = '';
        renderAllTeams();
        updateFixtureTeams();
        updateMatchTeams();
        showNotification(`Team "${name}" added!`, 'success');
    }

    function removeTeam(division, index) {
        if (!confirm(`Remove "${leagueData.teams[division][index]}"?`)) return;
        const teamName = leagueData.teams[division][index];
        const logoKey = `${division}-${teamName}`;
        delete leagueData.logos.teams[logoKey];
        leagueData.teams[division].splice(index, 1);
        renderAllTeams();
        updateFixtureTeams();
        updateMatchTeams();
        showNotification(`${teamName} removed`, 'success');
    }

    function renderAllTeams() {
        Object.keys(leagueData.teams).forEach(division => {
            const container = document.getElementById(`${division}-teams`);
            let html = '';
            leagueData.teams[division].forEach((team, index) => {
                const logoKey = `${division}-${team}`;
                const logoSrc = leagueData.logos.teams[logoKey];
                html += `
                    <div class="team-card" onclick="showTeamDetails('${division}', '${team}')">
                        <div class="team-logo">
                            ${logoSrc ? `<img src="${logoSrc}" alt="${team}">` : team.charAt(0).toUpperCase()}
                        </div>
                        <h4>${team}</h4>
                    </div>
                `;
            });
            container.innerHTML = html || '<p>No teams in this division yet.</p>';
        });
    }

    // Fixtures
    function updateFixtureTeams() {
        const division = document.getElementById('fixture-division').value;
        const home = document.getElementById('fixture-home-team');
        const away = document.getElementById('fixture-away-team');
        home.innerHTML = '<option value="">Select...</option>';
        away.innerHTML = '<option value="">Select...</option>';
        leagueData.teams[division].forEach(t => {
            home.innerHTML += `<option value="${t}">${t}</option>`;
            away.innerHTML += `<option value="${t}">${t}</option>`;
        });
    }

    function addFixture() {
        const division = document.getElementById('fixture-division').value;
        const homeTeam = document.getElementById('fixture-home-team').value;
        const awayTeam = document.getElementById('fixture-away-team').value;
        const date = document.getElementById('fixture-date').value;
        const time = document.getElementById('fixture-time').value;

        if (!homeTeam || !awayTeam || !date || !time) {
            return showNotification('Fill all fields', 'error');
        }

        leagueData.fixtures.push({
            id: Date.now(),
            division, homeTeam, awayTeam, date, time, played: false
        });

        document.getElementById('fixture-home-team').selectedIndex = 0;
        document.getElementById('fixture-away-team').selectedIndex = 0;
        document.getElementById('fixture-date').value = '';
        document.getElementById('fixture-time').value = '';
        renderFixtures();
        renderAdminFixtures();
        showNotification('Fixture added!', 'success');
    }

    function renderFixtures() {
        const container = document.getElementById('fixtures-list');
        const upcoming = leagueData.fixtures
            .filter(f => !f.played)
            .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));

        let html = '';
        if (upcoming.length === 0) {
            html = '<p>No fixtures</p>';
        } else {
            upcoming.forEach(f => {
                html += `
                    <div class="fixture-item">
                        <div><strong>${getDivisionName(f.division)}</strong> - ${f.date} ${f.time}</div>
                        <div>${f.homeTeam} vs ${f.awayTeam}</div>
                    </div>
                `;
            });
        }
        container.innerHTML = html;
    }

    function renderAdminFixtures() {
        const container = document.getElementById('fixtures-list-admin');
        let html = '';
        leagueData.fixtures.forEach(f => {
            if (!f.played) {
                html += `
                    <div>
                        ${f.homeTeam} vs ${f.awayTeam} - ${f.date}
                        <button onclick="removeFixture(${f.id})">Delete</button>
                    </div>
                `;
            }
        });
        container.innerHTML = html;
    }

    function removeFixture(id) {
        leagueData.fixtures = leagueData.fixtures.filter(f => f.id !== id);
        renderFixtures();
        renderAdminFixtures();
        showNotification('Fixture removed', 'success');
    }

    // Results
    function updateMatchTeams() {
        const division = document.getElementById('match-division').value;
        const home = document.getElementById('match-home-team');
        const away = document.getElementById('match-away-team');
        home.innerHTML = '<option value="">Select...</option>';
        away.innerHTML = '<option value="">Select...</option>';
        leagueData.teams[division].forEach(t => {
            home.innerHTML += `<option value="${t}">${t}</option>`;
            away.innerHTML += `<option value="${t}">${t}</option>`;
        });
    }

    function addMatchResult() {
        const division = document.getElementById('match-division').value;
        const homeTeam = document.getElementById('match-home-team').value;
        const awayTeam = document.getElementById('match-away-team').value;
        const date = document.getElementById('match-date').value;
        const resultType = document.getElementById('match-result-type').value;

        if (!homeTeam || !awayTeam || !date) {
            return showNotification('Fill all fields', 'error');
        }

        let homeScore = 0, awayScore = 0, forfeit = false, forfeitTeam = null;

        if (resultType === 'forfeit') {
            forfeit = true;
            forfeitTeam = document.getElementById('match-forfeit-team').value;
            homeScore = forfeitTeam === 'home' ? 0 : 20;
            awayScore = forfeitTeam === 'away' ? 0 : 20;
        } else {
            homeScore = parseInt(document.getElementById('match-home-score').value);
            awayScore = parseInt(document.getElementById('match-away-score').value);
            if (isNaN(homeScore) || isNaN(awayScore)) return showNotification('Enter valid scores', 'error');
        }

        leagueData.results.unshift({
            division, homeTeam, awayTeam, date, homeScore, awayScore, forfeit, forfeitTeam, played: true
        });

        document.getElementById('match-home-team').selectedIndex = 0;
        document.getElementById('match-away-team').selectedIndex = 0;
        document.getElementById('match-date').value = '';
        document.getElementById('match-home-score').value = '';
        document.getElementById('match-away-score').value = '';
        document.getElementById('match-result-type').value = 'normal';
        document.getElementById('match-forfeit-team').value = 'home';
        showNotification('Result saved!', 'success');
        renderResults();
    }

    function renderResults() {
        const container = document.getElementById('results-list');
        let html = '';
        leagueData.results.slice(0, 20).forEach(r => {
            html += `
                <div class="result-item">
                    <div>${r.homeTeam} ${r.homeScore} - ${r.awayScore} ${r.awayTeam} (${r.date})</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // Standings
    function showDivisionStandings(division) {
        const teams = leagueData.teams[division];
        const results = leagueData.results.filter(r => r.division === division);
        const standings = teams.map(team => {
            const teamResults = results.filter(r => r.homeTeam === team || r.awayTeam === team);
            let wins = 0, losses = 0, pointsFor = 0, pointsAgainst = 0;
            teamResults.forEach(r => {
                const isHome = r.homeTeam === team;
                const teamScore = isHome ? r.homeScore : r.awayScore;
                const opponentScore = isHome ? r.awayScore : r.homeScore;
                pointsFor += teamScore;
                pointsAgainst += opponentScore;
                if (r.forfeit) {
                    if ((isHome && r.forfeitTeam === 'home') || (!isHome && r.forfeitTeam === 'away')) {
                        losses++;
                    } else {
                        wins++;
                    }
                } else {
                    if (teamScore > opponentScore) wins++;
                    else losses++;
                }
            });
            const points = wins * 2 + losses; // 2 for win, 1 for loss
            return { team, played: teamResults.length, wins, losses, pointsFor, pointsAgainst, points };
        });
        standings.sort((a, b) => b.points - a.points);

        const modal = document.getElementById('team-modal');
        const details = document.getElementById('team-details');
        let html = `<h2>${getDivisionName(division)} - Standings</h2><table><tr><th>Team</th><th>P</th><th>W</th><th>L</th><th>PF</th><th>PA</th><th>Pts</th></tr>`;
        standings.forEach(s => {
            html += `<tr><td>${s.team}</td><td>${s.played}</td><td>${s.wins}</td><td>${s.losses}</td><td>${s.pointsFor}</td><td>${s.pointsAgainst}</td><td>${s.points}</td></tr>`;
        });
        html += '</table>';
        details.innerHTML = html;
        modal.style.display = 'block';
    }

    // Team Details
    function showTeamDetails(division, teamName) {
        const modal = document.getElementById('team-modal');
        const details = document.getElementById('team-details');
        const results = leagueData.results.filter(r => r.homeTeam === teamName || r.awayTeam === teamName);
        let wins = 0, losses = 0, pointsFor = 0, pointsAgainst = 0;
        results.forEach(r => {
            const isHome = r.homeTeam === teamName;
            const teamScore = isHome ? r.homeScore : r.awayScore;
            const opponentScore = isHome ? r.awayScore : r.homeScore;
            pointsFor += teamScore;
            pointsAgainst += opponentScore;
            if (r.forfeit) {
                if ((isHome && r.forfeitTeam === 'home') || (!isHome && r.forfeitTeam === 'away')) {
                    losses++;
                } else {
                    wins++;
                }
            } else {
                if (teamScore > opponentScore) wins++;
                else losses++;
            }
        });
        const winRate = results.length > 0 ? ((wins / results.length) * 100).toFixed(1) : 0;
        const logoKey = `${division}-${teamName}`;
        const logoSrc = leagueData.logos.teams[logoKey];
        const teamLogo = logoSrc ? `<img src="${logoSrc}" alt="${teamName}" style="width: 100px; height: 100px; border-radius: 50%; margin: 1rem auto; display: block;">` : '';
        let html = `<h2>${teamName}</h2>${teamLogo}<p><strong>Division:</strong> ${getDivisionName(division)}</p>`;
        html += `<p><strong>Wins:</strong> ${wins} | <strong>Losses:</strong> ${losses} | <strong>Win Rate:</strong> ${winRate}%</p>`;
        html += `<p><strong>Total Points:</strong> ${pointsFor} scored, ${pointsAgainst} conceded</p>`;
        html += `<h3>Recent Results</h3><ul>`;
        results.slice(-5).reverse().forEach(r => {
            const opponent = r.homeTeam === teamName ? r.awayTeam : r.homeTeam;
            const isWin = (r.homeTeam === teamName && r.homeScore > r.awayScore) || (r.awayTeam === teamName && r.awayScore > r.homeScore);
            html += `<li>${isWin ? 'Won' : 'Lost'} ${r.homeScore}-${r.awayScore} vs ${opponent} (${r.date})</li>`;
        });
        html += '</ul>';
        details.innerHTML = html;
        modal.style.display = 'block';
    }

    // Utils
    function getDivisionName(division) {
        return {
            'first': 'First Division',
            'second': 'Second Division',
            'female': 'Female Division',
            'third-jj': 'Third Division - JJ Roberts',
            'third-ej': 'Third Division - EJ Roye'
        }[division] || division;
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    window.onclick = function(e) {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    };
</script>
